schema: draft-07
name: "azure-storage-account-application-assets"
description: "Azure Blob storage is optimized for storing unstructured data. This storage solution is ideal for storing any files produced and consumed by your application internally."
source_url: github.com/massdriver-cloud/azure-storage-account-application-assets
access: "private"
type: "infrastructure"

params:
  examples:
    - __name: Development
      redundancy:
        data_protection: true
        data_protection_days: 7
    - __name: Production
      redundancy:
        data_protection: true
        data_protection_days: 365
  required:
    - redundancy
    - monitoring
  properties:
    redundancy:
      title: Data Redundancy
      type: object
      required:
        - replication_type
      properties:
        zone_redundancy:
          title: Enable zone redundancy (cannot be changed after creation)
          description: Enable zone redundancy for the storage account
          type: boolean
          default: false
          # This is immutable because users can freely swap between LRS, GRS, and RAGRS, or ZRS, GZRS, and RAGZRS. Users cannot swap between non-zone-redundant and zone-redundant replication types.
          $md.immutable: true
        data_protection:
          title: Enable data protection
          default: false
          type: boolean
      dependencies:
        zone_redundancy:
          oneOf:
            - properties:
                zone_redundancy:
                  const: false
                replication_type:
                  title: Replication type
                  description: The type of replication to use for the storage account.
                  type: string
                  oneOf:
                    - title: Local-redundant storage
                      const: LRS
                    - title: Geo-redundant storage
                      const: GRS
                    - title: Geo-redundant storage (read-access)
                      const: RAGRS
            - properties:
                zone_redundancy:
                  const: true
                replication_type:
                  title: Replication type
                  description: "The type of replication to use for the storage account. **West US and North Central US do not support zone-redundant storage**."
                  type: string
                  oneOf:
                    - title: Zone-redundant storage
                      const: ZRS
                    - title: Geo-zone-redundant Storage
                      const: GZRS
                    - title: Geo-zone-redundant storage (read-access)
                      const: RAGZRS
        data_protection:
          oneOf:
            - properties:
                data_protection:
                  const: true
                data_protection_days:
                  title: Data protection settings
                  description: Set the number of days to allow data recovery if data is deleted (minimum 1, maximum 365).
                  type: integer
                  minimum: 1
                  maximum: 365
              required:
                - data_protection_days
            # Confirmed with Dave that this is the correct way to handle this dependency.
            - properties:
                data_protection:
                  const: false
    monitoring:
      type: object
      title: Monitoring
      properties:
        mode:
          title: Alarm Mode
          description: Enable and customize Function App metric alarms.
          type: string
          default: DISABLED
          oneOf:
            - const: DISABLED
              title: Disabled
      dependencies:
        mode:
          oneOf:
            - properties:
                mode:
                  const: AUTOMATED
            - properties:
                mode:
                  const: DISABLED

connections:
  required:
    - azure_service_principal
    - azure_virtual_network
  properties:
    azure_service_principal:
      $ref: massdriver/azure-service-principal
    azure_virtual_network:
      $ref: massdriver/azure-virtual-network

artifacts:
  required:
    - azure_storage_account
  properties:
    azure_storage_account:
      $ref: massdriver/azure-storage-account

ui:
  ui:order:
    - redundancy
    - monitoring
    - "*"
  redundancy:
    ui:order:
      - zone_redundancy
      - replication_type
      - data_protection
      - data_protection_days
      - "*"
  monitoring:
    ui:order:
      - mode
      - '*'
