schema: draft-07
name: "azure-storage-account-application-assets"
description: "Azure Blob storage is optimized for storing unstructured data. This storage solution is ideal for storing any files produced and consumed by your application internally."
source_url: github.com/massdriver-cloud/azure-storage-account-application-assets
access: "private"
type: "bundle"

params:
  examples:
    - __name: Development
      redundancy:
        data_protection: true
        data_protection_days: 7
    - __name: Production
      redundancy:
        data_protection: true
        data_protection_days: 365
  required:
    - storage
    - redundancy
  properties:
    storage:
      title: Storage
      type: object
      required:
        - region
      properties:
        region:
          title: Region
          description: The region in which the storage account will be located (cannot be changed after deployment).
          $md.immutable: true
          $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/azure-region.json
    redundancy:
      title: Data Redundancy
      type: object
      required:
        - replication_type
      properties:
        replication_type:
          title: Replication type
          description: The type of replication to use for the storage account.
          type: string
          oneOf:
            - title: Local-redundant storage
              const: LRS
            - title: Geo-redundant storage
              const: GRS
            - title: Geo-redundant storage (read-access)
              const: RAGRS
        data_protection:
          title: Enable data protection
          default: false
          type: boolean
      dependencies:
        data_protection:
          oneOf:
            - properties:
                data_protection:
                  const: true
                data_protection_days:
                  title: Data protection settings
                  description: Set the number of days to allow data recovery if data is deleted (minimum 1, maximum 365).
                  type: integer
                  minimum: 1
                  maximum: 365
              required:
                - data_protection_days
            # Confirmed with Dave that this is the correct way to handle this dependency.
            - properties:
                data_protection:
                  const: false
  dependencies:
    storage:
      oneOf:
        - properties:
            storage:
              properties:
                region:
                # East US and South Central US support zone redundancy
                  enum:
                    - eastus
                    - southcentralus
            redundancy:
              properties:
                zone_redundancy:
                  title: Enable zone redundancy
                  description: Enable zone redundancy for the storage account
                  type: boolean
                  # This is immutable because users can freely swap between LRS, GRS, and RAGRS, or ZRS, GZRS, and RAGZRS. Users cannot swap between non-zone-redundant and zone-redundant replication types.
                  $md.immutable: true
              dependencies:
              # Replication type is set above and set here because the JSON schema wouldn't work otherwise with just one or the other.
                zone_redundancy:
                  oneOf:
                    - properties:
                        zone_redundancy:
                          const: true
                        replication_type:
                          oneOf:
                            - title: Zone-redundant storage
                              const: ZRS
                            - title: Geo-zone-redundant storage
                              const: GZRS
                            - title: Geo-zone-redundant storage (read-access)
                              const: RAGZRS
                    - properties:
                        zone_redundancy:
                          const: false
                        replication_type:
                          oneOf:
                            - title: Local-redundant storage
                              const: LRS
                            - title: Geo-redundant storage
                              const: GRS
                            - title: Geo-redundant storage (read-access)
                              const: RAGRS
        - properties:
            storage:
              properties:
                region:
                # West US and North Central US do not support zone redundancy.
                  enum:
                    - westus
                    - northcentralus
            redundancy:
              properties:
                replication_type:
                  oneOf:
                    - title: Local-redundant storage
                      const: LRS
                    - title: Geo-redundant storage
                      const: GRS
                    - title: Geo-redundant storage (read-access)
                      const: RAGRS
  allOf:
    - if:
        properties:
          redundancy:
            properties:
              zone_redundancy:
                const: true
      then:
        properties:
          redundancy:
            properties:
              replication_type:
                oneOf:
                  - title: Zone-redundant storage
                    const: ZRS
                  - title: Geo-zone-redundant storage
                    const: GZRS
                  - title: Geo-zone-redundant storage (read-access)
                    const: RAGZRS
      else:
        properties:
          redundancy:
            properties:
              replication_type:
                oneOf:
                  - title: Local-redundant storage
                    const: LRS
                  - title: Geo-redundant storage
                    const: GRS
                  - title: Geo-redundant storage (read-access)
                    const: RAGRS

connections:
  required:
    - azure_service_principal
  properties:
    azure_service_principal:
      $ref: massdriver/azure-service-principal

artifacts:
  required:
    - azure_storage_account
  properties:
    azure_storage_account:
      $ref: massdriver/azure-storage-account

ui:
  ui:order:
    - storage
    - redundancy
    - "*"
  storage:
    ui:order:
      - region
      - "*"
  redundancy:
    ui:order:
      - zone_redundancy
      - replication_type
      - data_protection
      - data_protection_days
      - "*"
